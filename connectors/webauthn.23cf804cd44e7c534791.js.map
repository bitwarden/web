{"version":3,"file":"connectors/webauthn.23cf804cd44e7c534791.js","mappings":"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","sources":["webpack://@bitwarden/web-vault/./src/connectors/common-webauthn.ts","webpack://@bitwarden/web-vault/./src/connectors/common.ts","webpack://@bitwarden/web-vault/webpack/bootstrap","webpack://@bitwarden/web-vault/webpack/runtime/make namespace object","webpack://@bitwarden/web-vault/./src/connectors/webauthn.ts"],"sourcesContent":["export function buildDataString(assertedCredential: PublicKeyCredential) {\n  const response = assertedCredential.response as AuthenticatorAssertionResponse;\n\n  const authData = new Uint8Array(response.authenticatorData);\n  const clientDataJSON = new Uint8Array(response.clientDataJSON);\n  const rawId = new Uint8Array(assertedCredential.rawId);\n  const sig = new Uint8Array(response.signature);\n\n  const data = {\n    id: assertedCredential.id,\n    rawId: coerceToBase64Url(rawId),\n    type: assertedCredential.type,\n    extensions: assertedCredential.getClientExtensionResults(),\n    response: {\n      authenticatorData: coerceToBase64Url(authData),\n      clientDataJson: coerceToBase64Url(clientDataJSON),\n      signature: coerceToBase64Url(sig),\n    },\n  };\n\n  return JSON.stringify(data);\n}\n\nexport function parseWebauthnJson(jsonString: string) {\n  const json = JSON.parse(jsonString);\n\n  const challenge = json.challenge.replace(/-/g, \"+\").replace(/_/g, \"/\");\n  json.challenge = Uint8Array.from(atob(challenge), (c) => c.charCodeAt(0));\n\n  json.allowCredentials.forEach((listItem: any) => {\n    // eslint-disable-next-line\n    const fixedId = listItem.id.replace(/\\_/g, \"/\").replace(/\\-/g, \"+\");\n    listItem.id = Uint8Array.from(atob(fixedId), (c) => c.charCodeAt(0));\n  });\n\n  return json;\n}\n\n// From https://github.com/abergs/fido2-net-lib/blob/b487a1d47373ea18cd752b4988f7262035b7b54e/Demo/wwwroot/js/helpers.js#L34\n// License: https://github.com/abergs/fido2-net-lib/blob/master/LICENSE.txt\nfunction coerceToBase64Url(thing: any) {\n  // Array or ArrayBuffer to Uint8Array\n  if (Array.isArray(thing)) {\n    thing = Uint8Array.from(thing);\n  }\n\n  if (thing instanceof ArrayBuffer) {\n    thing = new Uint8Array(thing);\n  }\n\n  // Uint8Array to base64\n  if (thing instanceof Uint8Array) {\n    let str = \"\";\n    const len = thing.byteLength;\n\n    for (let i = 0; i < len; i++) {\n      str += String.fromCharCode(thing[i]);\n    }\n    thing = window.btoa(str);\n  }\n\n  if (typeof thing !== \"string\") {\n    throw new Error(\"could not coerce to string\");\n  }\n\n  // base64 to base64url\n  // NOTE: \"=\" at the end of challenge is optional, strip it off here\n  thing = thing.replace(/\\+/g, \"-\").replace(/\\//g, \"_\").replace(/=*$/g, \"\");\n\n  return thing;\n}\n","export function getQsParam(name: string) {\n  const url = window.location.href;\n  // eslint-disable-next-line\n  name = name.replace(/[\\[\\]]/g, \"\\\\$&\");\n  const regex = new RegExp(\"[?&]\" + name + \"(=([^&#]*)|&|#|$)\");\n  const results = regex.exec(url);\n\n  if (!results) {\n    return null;\n  }\n  if (!results[2]) {\n    return \"\";\n  }\n\n  return decodeURIComponent(results[2].replace(/\\+/g, \" \"));\n}\n\nexport function b64Decode(str: string, spaceAsPlus = false) {\n  if (spaceAsPlus) {\n    str = str.replace(/ /g, \"+\");\n  }\n\n  return decodeURIComponent(\n    Array.prototype.map\n      .call(atob(str), (c: string) => {\n        return \"%\" + (\"00\" + c.charCodeAt(0).toString(16)).slice(-2);\n      })\n      .join(\"\")\n  );\n}\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","import { b64Decode, getQsParam } from \"./common\";\nimport { buildDataString, parseWebauthnJson } from \"./common-webauthn\";\n\nrequire(\"./webauthn.scss\");\n\nconst mobileCallbackUri = \"bitwarden://webauthn-callback\";\n\nlet parsed = false;\nlet webauthnJson: any;\nlet headerText: string = null;\nlet btnText: string = null;\nlet btnReturnText: string = null;\nlet parentUrl: string = null;\nlet parentOrigin: string = null;\nlet mobileResponse = false;\nlet stopWebAuthn = false;\nlet sentSuccess = false;\nlet obj: any = null;\n\ndocument.addEventListener(\"DOMContentLoaded\", () => {\n  init();\n\n  parseParameters();\n  if (headerText) {\n    const header = document.getElementById(\"webauthn-header\");\n    header.innerText = decodeURI(headerText);\n  }\n  if (btnText) {\n    const button = document.getElementById(\"webauthn-button\");\n    button.innerText = decodeURI(btnText);\n    button.onclick = executeWebAuthn;\n  }\n});\n\nfunction init() {\n  start();\n  onMessage();\n  info(\"ready\");\n}\n\nfunction parseParameters() {\n  if (parsed) {\n    return;\n  }\n\n  parentUrl = getQsParam(\"parent\");\n  if (!parentUrl) {\n    error(\"No parent.\");\n    return;\n  } else {\n    parentUrl = decodeURIComponent(parentUrl);\n    parentOrigin = new URL(parentUrl).origin;\n  }\n\n  const version = getQsParam(\"v\");\n\n  if (version === \"1\") {\n    parseParametersV1();\n  } else {\n    parseParametersV2();\n  }\n  parsed = true;\n}\n\nfunction parseParametersV1() {\n  const data = getQsParam(\"data\");\n  if (!data) {\n    error(\"No data.\");\n    return;\n  }\n\n  webauthnJson = b64Decode(data);\n  headerText = getQsParam(\"headerText\");\n  btnText = getQsParam(\"btnText\");\n  btnReturnText = getQsParam(\"btnReturnText\");\n}\n\nfunction parseParametersV2() {\n  let dataObj: {\n    data: any;\n    headerText: string;\n    btnText: string;\n    btnReturnText: string;\n    callbackUri?: string;\n    mobile?: boolean;\n  } = null;\n  try {\n    dataObj = JSON.parse(b64Decode(getQsParam(\"data\")));\n  } catch (e) {\n    error(\"Cannot parse data.\");\n    return;\n  }\n\n  mobileResponse = dataObj.callbackUri != null || dataObj.mobile === true;\n  webauthnJson = dataObj.data;\n  headerText = dataObj.headerText;\n  btnText = dataObj.btnText;\n  btnReturnText = dataObj.btnReturnText;\n}\n\nfunction start() {\n  sentSuccess = false;\n\n  if (!(\"credentials\" in navigator)) {\n    error(\"WebAuthn is not supported in this browser.\");\n    return;\n  }\n\n  parseParameters();\n  if (!webauthnJson) {\n    error(\"No data.\");\n    return;\n  }\n\n  try {\n    obj = parseWebauthnJson(webauthnJson);\n  } catch (e) {\n    error(\"Cannot parse webauthn data.\");\n    return;\n  }\n\n  stopWebAuthn = false;\n\n  if (\n    mobileResponse ||\n    (navigator.userAgent.indexOf(\" Safari/\") !== -1 && navigator.userAgent.indexOf(\"Chrome\") === -1)\n  ) {\n    // Safari and mobile chrome blocks non-user initiated WebAuthn requests.\n  } else {\n    executeWebAuthn();\n  }\n}\n\nfunction executeWebAuthn() {\n  if (stopWebAuthn) {\n    return;\n  }\n\n  navigator.credentials.get({ publicKey: obj }).then(success).catch(error);\n}\n\nfunction onMessage() {\n  window.addEventListener(\n    \"message\",\n    (event) => {\n      if (!event.origin || event.origin === \"\" || event.origin !== parentOrigin) {\n        return;\n      }\n\n      if (event.data === \"stop\") {\n        stopWebAuthn = true;\n      } else if (event.data === \"start\" && stopWebAuthn) {\n        start();\n      }\n    },\n    false\n  );\n}\n\nfunction error(message: string) {\n  if (mobileResponse) {\n    document.location.replace(mobileCallbackUri + \"?error=\" + encodeURIComponent(message));\n    returnButton(mobileCallbackUri + \"?error=\" + encodeURIComponent(message));\n  } else {\n    parent.postMessage(\"error|\" + message, parentUrl);\n  }\n}\n\nfunction success(assertedCredential: PublicKeyCredential) {\n  if (sentSuccess) {\n    return;\n  }\n\n  const dataString = buildDataString(assertedCredential);\n\n  if (mobileResponse) {\n    document.location.replace(mobileCallbackUri + \"?data=\" + encodeURIComponent(dataString));\n    returnButton(mobileCallbackUri + \"?data=\" + encodeURIComponent(dataString));\n  } else {\n    parent.postMessage(\"success|\" + dataString, parentUrl);\n    sentSuccess = true;\n  }\n}\n\nfunction info(message: string) {\n  if (mobileResponse) {\n    return;\n  }\n\n  parent.postMessage(\"info|\" + message, parentUrl);\n}\n\nfunction returnButton(uri: string) {\n  // provides 'return' button in case scripted navigation is blocked\n  const button = document.getElementById(\"webauthn-button\");\n  button.innerText = decodeURI(btnReturnText);\n  button.onclick = () => {\n    document.location.replace(uri);\n  };\n}\n"],"names":["coerceToBase64Url","thing","Array","isArray","Uint8Array","from","ArrayBuffer","str","len","byteLength","i","String","fromCharCode","window","btoa","Error","replace","assertedCredential","response","authData","authenticatorData","clientDataJSON","rawId","sig","signature","data","id","type","extensions","getClientExtensionResults","clientDataJson","JSON","stringify","jsonString","json","parse","challenge","atob","c","charCodeAt","allowCredentials","forEach","listItem","fixedId","name","url","location","href","results","RegExp","exec","decodeURIComponent","spaceAsPlus","prototype","map","call","toString","slice","join","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","undefined","exports","module","__webpack_modules__","r","Symbol","toStringTag","Object","defineProperty","value","mobileCallbackUri","webauthnJson","parsed","headerText","btnText","btnReturnText","parentUrl","parentOrigin","mobileResponse","stopWebAuthn","sentSuccess","obj","parseParameters","getQsParam","error","URL","origin","b64Decode","parseParametersV1","dataObj","e","callbackUri","mobile","parseParametersV2","start","navigator","parseWebauthnJson","userAgent","indexOf","executeWebAuthn","credentials","get","publicKey","then","success","catch","message","document","encodeURIComponent","returnButton","parent","postMessage","dataString","buildDataString","uri","button","getElementById","innerText","decodeURI","onclick","addEventListener","event"],"sourceRoot":""}